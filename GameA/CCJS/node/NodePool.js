define(function(k,h){function n(a,e,b,d){var f=a in c?c[a].nodes.length:0,g=[],m=a+"_"+f+"_"+l.hex_md5(b);a in c?(p.debug("模型资源已存在，直接创建节点"),g=[q(c[a].resourceid,b),1,m],c[a].nodes[f]=g,p.debug("节点"+m+"创建完毕"),d&&d({id:m,node:g[0]})):(j=!1,r.load([{type:"item",uri:e}],function(a){var f=l.hex_md5(e);c[f]=[];c[f].resourceid=a[0];g=[q(c[f].resourceid,b),1,m];c[f].nodes=[g];j=!0;d&&d({id:g[2],node:g[0]})}))}function q(a,c){var b="";c?b=c.replace("s%","USE "+a):(b=b+"Transform{ children ["+("USE "+a),b+=
"]}");return new SFNode(b)}var c={},l=k("utils/Md5"),r=k("node/ResourceLoader"),p=k("core/Logger").getLog(),j=!1;h.init=function(a,e){if(j)e&&e();else{for(var b=[],d=0,f=a.length;d<f;d++)b[d]={type:"item",uri:a[d]};r.load(b,function(b){for(var d=0,f=b.length;d<f;d++){var h=l.hex_md5(a[d]);c[h]=[];c[h].resourceid=b[d];c[h].nodes=[]}j=!0;e&&e()})}};h.create=function(a,e,b){if(j){var d=l.hex_md5(a);if(d in c&&0<c[d].nodes.length)a:{for(var f=c[d].nodes,g=0,h=f.length;g<h;g++){var k=d+"_"+g+"_"+l.hex_md5(e);
if(f[g][2]==k&&0==f[g][1]){f[g][1]=1;b&&b({id:d+"_"+g,node:f[g][0]});break a}}n(d,a,e,b)}else n(d,a,e,b)}};h.remove=function(a){if(a){var e=a.split("_");c[e[0]].nodes[e[1]][1]=0}else for(e in c){a=0;for(var b=c[e].nodes.length;a<b;a++)c[e].nodes[a][1]=0}};h.destory=function(){j=!1;c={}}});
